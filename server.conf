upstream ecos {
  server ALFRESCO_TARGET; # replaced by ${PROXY_TARGET} in start.sh
}

#BEGIN_GATEWAY
upstream gateway {
  server GATEWAY_TARGET; #replaced by ${GATEWAY_TARGET}, or delete upstream in start.sh
}
#END_GATEWAY


map $HTTP_X_FORWARDED_PROTO $targetProto  {
  default $scheme;
  "https"    "https";
  "http"    "http";
}

server  {
  listen 8081;
  listen 80;
  server_name default_server;
  client_max_body_size 50m;
  access_log /var/log/nginx/access_ecos.log;
  error_log /var/log/nginx/error_ecos.log warn;

  #BEGIN_CADVISOR
    location /cadvisor/ {
      proxy_pass http://CADVISOR_TARGET/;   #replaced by ${CADVISOR_TARGET}, or delete upstream in start.sh
      proxy_redirect ~^/containers/ /cadvisor/containers/;
    	proxy_redirect ~^/docker/ /cadvisor/docker/;
      proxy_redirect ~^/metrics/ /cadvisor/metrics/;
      auth_basic "Restricted";                                #For Basic Auth
      auth_basic_user_file /etc/nginx/.htpasswd;  #For Basic Auth
    }
  #END_CADVISOR

  location ~ ^/ecosui/(.*) {
    root /var/www/assets;
    sub_filter '<a href="http://localhost:8080/'  '<a href="$targetProto://$host/';
    sub_filter '<a href="http://localhost/'  '<a href="$targetProto://$host/';
    try_files $uri $uri/ @proxy;
  }

  location ~ ^/share/page/(.*)card-details-new {
    root /var/www/assets;
    rewrite ^ /index.html break;
    sub_filter '<a href="http://localhost:8080/'  '<a href="$targetProto://$host/';
    sub_filter '<a href="http://localhost/'  '<a href="$targetProto://$host/';
    try_files $uri $uri/ @proxy;
  }

  location /share/page/bpmn-designer {
    alias /var/www/assets;
    sub_filter '<a href="http://localhost:8080/'  '<a href="$targetProto://$host/';
    sub_filter '<a href="http://localhost/'  '<a href="$targetProto://$host/';
    try_files $uri $uri/ @proxy;
  }

  location /share/page/bpmn-editor {
    alias /var/www/assets/bpmn-editor;
    sub_filter '<a href="http://localhost:8080/'  '<a href="$targetProto://$host/';
    sub_filter '<a href="http://localhost/'  '<a href="$targetProto://$host/';
    try_files $uri $uri/ @proxy;
  }

  location /share/page/journalsDashboard {
    alias /var/www/assets/;
    sub_filter '<a href="http://localhost:8080/'  '<a href="$targetProto://$host/';
    sub_filter '<a href="http://localhost/'  '<a href="$targetProto://$host/';
    try_files $uri $uri/ @proxy;
  }

  location /share/page/ui/journals {
    root /var/www/assets;
    rewrite ^ /index.html break;
    sub_filter '<a href="http://localhost:8080/'  '<a href="$targetProto://$host/';
    sub_filter '<a href="http://localhost/'  '<a href="$targetProto://$host/';
    try_files $uri $uri/ @proxy;
  }

  location /share/api/records/ {
    proxy_pass http://gateway/api/records/;
    proxy_redirect off;
    proxy_set_header      Host $host;
    proxy_set_header      X-Real-IP          $remote_addr;
    proxy_set_header      X-Forwarded-For    $proxy_add_x_forwarded_for;
    proxy_set_header      Upgrade            $http_upgrade;
    proxy_set_header      Connection         "upgrade";
    proxy_read_timeout    10d;
    proxy_connect_timeout 600;
    proxy_cache off;
    proxy_buffering off;
  }

  location / {
    if ($uri = /) {
      return 302 $targetProto://$host/share/page;
    }
    root /var/www/assets;
    try_files $uri $uri/ @proxy;
  }

  location  @proxy {
    proxy_pass  http://ecos;
    proxy_redirect off;
    proxy_set_header      Host $host;
    proxy_set_header      X-Real-IP          $remote_addr;
    proxy_set_header      X-Forwarded-For    $proxy_add_x_forwarded_for;
    proxy_set_header      Upgrade            $http_upgrade;
    proxy_set_header      Connection         "upgrade";
    proxy_read_timeout    10d;
    proxy_connect_timeout 600;
    proxy_cache off;
    proxy_buffering off;
  }

#BEGIN_GATEWAY_LOCATIONS
  location /share/proxy/alfresco/citeck/menu/menu {
    proxy_pass http://gateway/uiserv/api/usermenu;
    proxy_redirect off;
    proxy_set_header      Host $host;
    proxy_set_header      X-Real-IP          $remote_addr;
    proxy_set_header      X-Forwarded-For    $proxy_add_x_forwarded_for;
    proxy_set_header      Upgrade            $http_upgrade;
    proxy_set_header      Connection         "upgrade";
    proxy_read_timeout    10d;
    proxy_connect_timeout 600;
    proxy_cache off;
    proxy_buffering off;
  }

  location /micro/integrations/records/query {
    proxy_pass http://gateway/integrations/records/query;
    proxy_redirect off;
    proxy_set_header      Host $host;
    proxy_set_header      X-Real-IP          $remote_addr;
    proxy_set_header      X-Forwarded-For    $proxy_add_x_forwarded_for;
    proxy_set_header      Upgrade            $http_upgrade;
    proxy_set_header      Connection         "upgrade";
    proxy_read_timeout    10d;
    proxy_connect_timeout 600;
    proxy_cache off;
    proxy_buffering off;
  }

  location  /micro/integrations/api/records/query {
    proxy_pass http://gateway/integrations/api/records/query;
    proxy_redirect off;
    proxy_set_header      Host $host;
    proxy_set_header      X-Real-IP          $remote_addr;
    proxy_set_header      X-Forwarded-For    $proxy_add_x_forwarded_for;
    proxy_set_header      Upgrade            $http_upgrade;
    proxy_set_header      Connection         "upgrade";
    proxy_read_timeout    10d;
    proxy_connect_timeout 600;
    proxy_cache off;
    proxy_buffering off;
  }

  location /share/proxy/alfresco/citeck/micro/uiserv/themes/ {
    proxy_pass http://gateway/uiserv/themes/;
    proxy_redirect off;
    proxy_set_header      Host $host;
    proxy_set_header      X-Real-IP          $remote_addr;
    proxy_set_header      X-Forwarded-For    $proxy_add_x_forwarded_for;
    proxy_set_header      Upgrade            $http_upgrade;
    proxy_set_header      Connection         "upgrade";
    proxy_read_timeout    10d;
    proxy_connect_timeout 600;
    proxy_cache off;
    proxy_buffering off;
  }

  location  /share/proxy/alfresco/citeck/micro/uiserv/api/ {
    proxy_pass http://gateway/uiserv/api/;
    proxy_redirect off;
    proxy_set_header      Host $host;
    proxy_set_header      X-Real-IP          $remote_addr;
    proxy_set_header      X-Forwarded-For    $proxy_add_x_forwarded_for;
    proxy_set_header      Upgrade            $http_upgrade;
    proxy_set_header      Connection         "upgrade";
    proxy_read_timeout    10d;
    proxy_connect_timeout 600;
    proxy_cache off;
    proxy_buffering off;
  }
#END_GATEWAY_LOCATIONS
}
