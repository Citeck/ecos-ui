upstream ecos {
  server mailhog:8080;
}

upstream gateway {
  server gateway-app:8085;
}


map $HTTP_X_FORWARDED_PROTO $targetProto  {
  default $scheme;
  "https"    "https";
  "http"    "http";
}

server  {
  listen 8081;
  listen 80;
  server_name default_server;
    access_log /var/log/nginx/access_ecos.log;
    error_log /var/log/nginx/error_ecos.log warn;

  location ~ ^/ecosui/(.*) {
    root /var/www/assets;
    sub_filter '<a href="http://localhost:8080/'  '<a href="$targetProto://$host/';
    sub_filter '<a href="http://localhost/'  '<a href="$targetProto://$host/';
    try_files $uri $uri/ @proxy;
  }

  location ~ ^/share/page/(.*)card-details-new {
    root /var/www/assets;
    rewrite ^ /index.html break;
    sub_filter '<a href="http://localhost:8080/'  '<a href="$targetProto://$host/';
    sub_filter '<a href="http://localhost/'  '<a href="$targetProto://$host/';
    try_files $uri $uri/ @proxy;
  }

  location /share/page/bpmn-designer {
    alias /var/www/assets;
    sub_filter '<a href="http://localhost:8080/'  '<a href="$targetProto://$host/';
    sub_filter '<a href="http://localhost/'  '<a href="$targetProto://$host/';
    try_files $uri $uri/ @proxy;
  }

  location /share/page/bpmn-editor {
    alias /var/www/assets/bpmn-editor;
    sub_filter '<a href="http://localhost:8080/'  '<a href="$targetProto://$host/';
    sub_filter '<a href="http://localhost/'  '<a href="$targetProto://$host/';
    try_files $uri $uri/ @proxy;

  }

  location /share/page/journalsDashboard {
    alias /var/www/assets/;
    sub_filter '<a href="http://localhost:8080/'  '<a href="$targetProto://$host/';
    sub_filter '<a href="http://localhost/'  '<a href="$targetProto://$host/';
    try_files $uri $uri/ @proxy;
  }

  location / {
    if ($uri = /) {
      return 302 $targetProto://$host/share/page;
    }
    root /var/www/assets;
    try_files $uri $uri/ @proxy;
  }

  location  @proxy {
    proxy_pass  http://ecos;
    proxy_redirect off;
    proxy_set_header      Host $host;
    proxy_set_header      X-Real-IP          $remote_addr;
    proxy_set_header      X-Forwarded-For    $proxy_add_x_forwarded_for;
    proxy_set_header      Upgrade            $http_upgrade;
    proxy_set_header      Connection         "upgrade";
    proxy_read_timeout    10d;
    proxy_connect_timeout 600;
    proxy_cache off;
    proxy_buffering off;
  }
#    location  /share/proxy/alfresco/citeck/micro/uiserv/api/journalprefs {
#    proxy_pass http://gateway/uiserv/api/journalprefs$is_args$args;
#    proxy_redirect off;
#    proxy_set_header      Host $host;
#    proxy_set_header      X-Real-IP          $remote_addr;
#    proxy_set_header      X-Forwarded-For    $proxy_add_x_forwarded_for;
#    proxy_set_header      Upgrade            $http_upgrade;
#    proxy_set_header      Connection         "upgrade";
#    proxy_read_timeout    10d;
#    proxy_connect_timeout 600;
#    proxy_cache off;
#    proxy_buffering off;
#  }
    location /share/proxy/alfresco/citeck/menu/menu {
    proxy_pass http://gateway/uiserv/api/usermenu;
    proxy_redirect off;
    proxy_set_header      Host $host;
    proxy_set_header      X-Real-IP          $remote_addr;
    proxy_set_header      X-Forwarded-For    $proxy_add_x_forwarded_for;
    proxy_set_header      Upgrade            $http_upgrade;
    proxy_set_header      Connection         "upgrade";
    proxy_read_timeout    10d;
    proxy_connect_timeout 600;
    proxy_cache off;
    proxy_buffering off;

  }
    location /micro/integrations/records/query {
    proxy_pass http://gateway/integrations/records/query;
    proxy_redirect off;
    proxy_set_header      Host $host;
    proxy_set_header      X-Real-IP          $remote_addr;
    proxy_set_header      X-Forwarded-For    $proxy_add_x_forwarded_for;
    proxy_set_header      Upgrade            $http_upgrade;
    proxy_set_header      Connection         "upgrade";
    proxy_read_timeout    10d;
    proxy_connect_timeout 600;
    proxy_cache off;
    proxy_buffering off;
  }
    location  /micro/integrations/api/records/query {
    proxy_pass http://gateway/integrations/api/records/query;
    proxy_redirect off;
    proxy_set_header      Host $host;
    proxy_set_header      X-Real-IP          $remote_addr;
    proxy_set_header      X-Forwarded-For    $proxy_add_x_forwarded_for;
    proxy_set_header      Upgrade            $http_upgrade;
    proxy_set_header      Connection         "upgrade";
    proxy_read_timeout    10d;
    proxy_connect_timeout 600;
    proxy_cache off;
    proxy_buffering off;
  }
#    location  /share/proxy/alfresco/citeck/micro/uiserv/api/journalprefs/list {
#    proxy_pass http://gateway/uiserv/api/journalprefs/list$is_args$args;
#    proxy_redirect off;
#    proxy_set_header      Host $host;
#    proxy_set_header      X-Real-IP          $remote_addr;
#    proxy_set_header      X-Forwarded-For    $proxy_add_x_forwarded_for;
#    proxy_set_header      Upgrade            $http_upgrade;
#    proxy_set_header      Connection         "upgrade";
#    proxy_read_timeout    10d;
#    proxy_connect_timeout 600;
#    proxy_cache off;
#    proxy_buffering off;
#  }
#    location /share/proxy/alfresco/citeck/micro/uiserv/api/journalprefs/id/ {
#    proxy_pass http://gateway/uiserv/api/journalprefs/id/;
#    proxy_redirect off;
#    proxy_set_header      Host $host;
#    proxy_set_header      X-Real-IP          $remote_addr;
#    proxy_set_header      X-Forwarded-For    $proxy_add_x_forwarded_for;
#    proxy_set_header      Upgrade            $http_upgrade;
#    proxy_set_header      Connection         "upgrade";
#    proxy_read_timeout    10d;
#    proxy_connect_timeout 600;
#    proxy_cache off;
#    proxy_buffering off;
#  }
    location /share/proxy/alfresco/citeck/micro/uiserv/themes/ {
    proxy_pass http://gateway/uiserv/themes/;
    proxy_redirect off;
    proxy_set_header      Host $host;
    proxy_set_header      X-Real-IP          $remote_addr;
    proxy_set_header      X-Forwarded-For    $proxy_add_x_forwarded_for;
    proxy_set_header      Upgrade            $http_upgrade;
    proxy_set_header      Connection         "upgrade";
    proxy_read_timeout    10d;
    proxy_connect_timeout 600;
    proxy_cache off;
    proxy_buffering off;
  }
#    location /share/proxy/alfresco/citeck/micro/uiserv/api/themes/ {
#    proxy_pass http://gateway/uiserv/api/themes/;
#    proxy_redirect off;
#    proxy_set_header      Host $host;
#    proxy_set_header      X-Real-IP          $remote_addr;
#    proxy_set_header      X-Forwarded-For    $proxy_add_x_forwarded_for;
#    proxy_set_header      Upgrade            $http_upgrade;
#    proxy_set_header      Connection         "upgrade";
#    proxy_read_timeout    10d;
#    proxy_connect_timeout 600;
#    proxy_cache off;
#    proxy_buffering off;
#  }
#    location /share/proxy/alfresco/citeck/micro/uiserv/api/themes/current {
#    proxy_pass http://gateway/uiserv/api/themes/current$is_args$args;
#    proxy_redirect off;
#    proxy_set_header      Host $host;
#    proxy_set_header      X-Real-IP          $remote_addr;
#    proxy_set_header      X-Forwarded-For    $proxy_add_x_forwarded_for;
#    proxy_set_header      Upgrade            $http_upgrade;
#    proxy_set_header      Connection         "upgrade";
#    proxy_read_timeout    10d;
#    proxy_connect_timeout 600;
#    proxy_cache off;
#    proxy_buffering off;
#  }
    location  /share/proxy/alfresco/citeck/micro/uiserv/api/ {
    proxy_pass http://gateway/uiserv/api/;
    proxy_redirect off;
    proxy_set_header      Host $host;
    proxy_set_header      X-Real-IP          $remote_addr;
    proxy_set_header      X-Forwarded-For    $proxy_add_x_forwarded_for;
    proxy_set_header      Upgrade            $http_upgrade;
    proxy_set_header      Connection         "upgrade";
    proxy_read_timeout    10d;
    proxy_connect_timeout 600;
    proxy_cache off;
    proxy_buffering off;
  }
}