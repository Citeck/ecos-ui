upstream ecos {
}
upstream gateway {
  server gateway-app:8085;
}

map $HTTP_X_FORWARDED_PROTO $targetProto  {
  default $scheme;
  "https"    "https";
  "http"    "http";
}

server  {
  listen 8081;
  listen 80;
  server_name default_server;

  location ~ ^/share/page/(.*)card-details-new {
    root /var/www/assets;
    rewrite ^ /index.html break;
    sub_filter '<a href="http://localhost:8080/'  '<a href="$targetProto://$host/';
    sub_filter '<a href="http://localhost/'  '<a href="$targetProto://$host/';
    try_files $uri $uri/ @proxy;
  }

  location /share/page/bpmn-designer {
    alias /var/www/assets;
    sub_filter '<a href="http://localhost:8080/'  '<a href="$targetProto://$host/';
    sub_filter '<a href="http://localhost/'  '<a href="$targetProto://$host/';
    try_files $uri $uri/ @proxy;
  }

  location /share/page/bpmn-editor {
    alias /var/www/assets/bpmn-editor;
    sub_filter '<a href="http://localhost:8080/'  '<a href="$targetProto://$host/';
    sub_filter '<a href="http://localhost/'  '<a href="$targetProto://$host/';
    try_files $uri $uri/ @proxy;

  }

  location /share/page/journalsDashboard {
    alias /var/www/assets/;
    sub_filter '<a href="http://localhost:8080/'  '<a href="$targetProto://$host/';
    sub_filter '<a href="http://localhost/'  '<a href="$targetProto://$host/';
    try_files $uri $uri/ @proxy;
  }

  location / {
    if ($uri = /) {
      return 302 $targetProto://$host/share/page;
    }
    root /var/www/assets;
    try_files $uri $uri/ @proxy;
  }

  location  @proxy {
    proxy_pass  http://ecos;
    proxy_redirect off;
    proxy_set_header      Host $host;
    proxy_set_header      X-Real-IP          $remote_addr;
    proxy_set_header      X-Forwarded-For    $proxy_add_x_forwarded_for;
    proxy_set_header      Upgrade            $http_upgrade;
    proxy_set_header      Connection         "upgrade";
    proxy_read_timeout    10d;
    proxy_connect_timeout 600;
    proxy_cache off;
    proxy_buffering off;
  }
    location  /micro/uiserv/api/journalprefs {
    proxy_pass $scheme://gateway/uiserv/api/journalprefs;
    proxy_redirect off;
    proxy_set_header      Host $host;
    proxy_set_header      X-Real-IP          $remote_addr;
    proxy_set_header      X-Forwarded-For    $proxy_add_x_forwarded_for;
    proxy_set_header      Upgrade            $http_upgrade;
    proxy_set_header      Connection         "upgrade";
    proxy_read_timeout    10d;
    proxy_connect_timeout 600;
    proxy_cache off;
    proxy_buffering off;
  }
    location /share/proxy/alfresco/citeck/menu/menu {
    proxy_pass $scheme://gateway/uiserv/api/usermenu;
    proxy_redirect off;
    proxy_set_header      Host $host;
    proxy_set_header      X-Real-IP          $remote_addr;
    proxy_set_header      X-Forwarded-For    $proxy_add_x_forwarded_for;
    proxy_set_header      Upgrade            $http_upgrade;
    proxy_set_header      Connection         "upgrade";
    proxy_read_timeout    10d;
    proxy_connect_timeout 600;
    proxy_cache off;
    proxy_buffering off;

  }
    location /micro/integrations/records/query {
    proxy_pass $scheme://gateway/integrations/records/query;
    proxy_redirect off;
    proxy_set_header      Host $host;
    proxy_set_header      X-Real-IP          $remote_addr;
    proxy_set_header      X-Forwarded-For    $proxy_add_x_forwarded_for;
    proxy_set_header      Upgrade            $http_upgrade;
    proxy_set_header      Connection         "upgrade";
    proxy_read_timeout    10d;
    proxy_connect_timeout 600;
    proxy_cache off;
    proxy_buffering off;
  }
    location  /micro/integrations/records/api/query {
    proxy_pass $scheme://gateway/integrations/records/api/query;
    proxy_redirect off;
    proxy_set_header      Host $host;
    proxy_set_header      X-Real-IP          $remote_addr;
    proxy_set_header      X-Forwarded-For    $proxy_add_x_forwarded_for;
    proxy_set_header      Upgrade            $http_upgrade;
    proxy_set_header      Connection         "upgrade";
    proxy_read_timeout    10d;
    proxy_connect_timeout 600;
    proxy_cache off;
    proxy_buffering off;
  }
}
